# SPDX-License-Identifier: AGPL-3.0-or-later
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: read-all

env:
  CARGO_TERM_COLOR: always

jobs:
  rust:
    name: Rust Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b # stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Check
        run: cargo check --manifest-path rust/Cargo.toml

      - name: Clippy
        run: cargo clippy --manifest-path rust/Cargo.toml -- -D warnings

      - name: Format
        run: cargo fmt --manifest-path rust/Cargo.toml -- --check

      - name: Test
        run: cargo test --manifest-path rust/Cargo.toml

      - name: Build release
        run: cargo build --manifest-path rust/Cargo.toml --release

  zig:
    name: Zig Bridge
    runs-on: ubuntu-latest
    needs: rust
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: goto-bus-stop/setup-zig@7ab2955eb728f5e895a59de1d0b23eeefbca9e8e # v2
        with:
          version: 0.13.0

      - name: Build
        working-directory: zig
        run: zig build

      - name: Test
        working-directory: zig
        run: zig build test

  ada:
    name: Ada TUI
    runs-on: ubuntu-latest
    needs: zig
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install GNAT
        run: |
          sudo apt-get update
          sudo apt-get install -y gnat gprbuild

      - name: Build (check syntax only)
        working-directory: ada
        run: |
          # Syntax check only - full build requires linked libraries
          gnat compile -c -gnatc src/*.adb src/*.ads || true
